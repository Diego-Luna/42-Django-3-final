<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Chat - {{ room_name }}</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-3">
	<div class="container-fluid">
		<div class="row">
			<div class="col-12">
				<h3>Chat Room: {{ room_name }}</h3>
				<p class="text-muted">Logged in as: <strong>{{ username }}</strong> | <a href="/chat/">Back to rooms</a></p>
			</div>
		</div>

		<div class="row mt-3">
			<div class="col-12">
				<div id="chat-messages" class="border p-3 bg-light" style="height: 400px; overflow-y: auto;">
				</div>
			</div>
		</div>

		<div class="row mt-3">
			<div class="col-12">
				<form id="chat-form">
					<div class="input-group">
						<input 
							type="text" 
							id="chat-message-input" 
							class="form-control" 
							placeholder="Type your message..."
							autocomplete="off"
							required
						>
						<button type="submit" class="btn btn-primary">Send</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.08/dist/js/bootstrap.bundle.min.js"></script>
	
	<script>
		const roomName = "{{ room_name }}";
		const username = "{{ username }}";
		
		const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
		const wsUrl = protocol + '//' + window.location.host + '/ws/chat/' + roomName + '/';
		const chatSocket = new WebSocket(wsUrl);

		chatSocket.onopen = function(e) {
			console.log('WebSocket connection established');
		};

		chatSocket.onmessage = function(e) {
			const data = JSON.parse(e.data);
			
			if (data.type === 'history') {
				// Display message history
				$('#chat-messages').append('<div class="mb-2 text-muted fst-italic small">--- Message History ---</div>');
				data.messages.forEach(function(msg) {
					const messageDiv = $('<div class="mb-2 text-secondary"></div>');
					const usernameSpan = $('<strong></strong>').text(msg.username + ': ');
					const messageText = $('<span></span>').text(msg.message);
					messageDiv.append(usernameSpan).append(messageText);
					$('#chat-messages').append(messageDiv);
				});
				if (data.messages.length > 0) {
					$('#chat-messages').append('<div class="mb-2 text-muted fst-italic small">--- End History ---</div>');
				}
			} else if (data.type === 'user_join') {
				const joinMessage = $('<div class="mb-2 text-muted fst-italic"></div>')
					.text(data.username + ' has joined the chat');
				$('#chat-messages').append(joinMessage);
			} else if (data.type === 'message') {
				const messageDiv = $('<div class="mb-2"></div>');
				const usernameSpan = $('<strong></strong>').text(data.username + ': ');
				const messageText = $('<span></span>').text(data.message);
				messageDiv.append(usernameSpan).append(messageText);
				$('#chat-messages').append(messageDiv);
			}
			
			$('#chat-messages').scrollTop($('#chat-messages')[0].scrollHeight);
		};

		chatSocket.onclose = function(e) {
			console.log('WebSocket connection closed');
		};

		chatSocket.onerror = function(e) {
			console.error('WebSocket error:', e);
		};

		$('#chat-form').on('submit', function(e) {
			e.preventDefault();
			
			const messageInput = $('#chat-message-input');
			const message = messageInput.val().trim();
			
			if (message) {
				chatSocket.send(JSON.stringify({
					'message': message
				}));
				messageInput.val('');
			}
		});
	</script>
</body>
</html>
