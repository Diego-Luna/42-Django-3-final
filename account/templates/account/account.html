<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Account - Login/Logout</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-5">
	<div class="container" style="max-width: 400px;">
		<!-- Login Form -->
		<div id="authForm">
			<h2>Login</h2>
			
			<div id="formErrors" class="d-none">
				<div class="alert alert-danger" role="alert">
					<strong>Login Error:</strong>
					<ul id="errorsList" class="mb-0 ps-3"></ul>
				</div>
			</div>
			
			<form id="loginForm">
				{% csrf_token %}
				<div class="mb-3">
					<label for="username" class="form-label">Username</label>
					<input 
						type="text" 
						class="form-control" 
						id="username" 
						name="username" 
						required
						placeholder="Enter your username"
					>
				</div>
				<div class="mb-3">
					<label for="password" class="form-label">Password</label>
					<input 
						type="password" 
						class="form-control" 
						id="password" 
						name="password" 
						required
						placeholder="Enter your password"
					>
				</div>
				<button type="submit" class="btn btn-primary w-100">Login</button>
			</form>
		</div>
		

		<div id="authContent" class="d-none">
			<h2>Welcome</h2>
			<p>Logged as <strong id="username-display"></strong></p>
			<button id="logoutBtn" class="btn btn-danger w-100">Logout</button>
		</div>
	</div>

	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	
	<script>
		$(document).ready(function() {
			
			function getCsrfToken() {
				const cookies = document.cookie.split(';');
				for (let i = 0; i < cookies.length; i++) {
					const cookie = cookies[i].trim();
					if (cookie.startsWith('csrftoken=')) {
						return cookie.split('=')[1];
					}
				}
				return null;
			}
			
			checkAuthStatus();
			
			function checkAuthStatus() {
				$.get('/account/status/', function(data) {
					if (data.authenticated) {
						$('#username-display').text(data.username);
						$('#authForm').addClass('d-none');
						$('#authContent').removeClass('d-none');
					}
				});
			}
			
			$('#loginForm').on('submit', function(e) {
				e.preventDefault();
				
				$.post('/account/login/', {
					username: $('#username').val(),
					password: $('#password').val(),
					csrfmiddlewaretoken: getCsrfToken()
				})
				.done(function(data) {
					$('#username-display').text(data.username);
					$('#authForm').addClass('d-none');
					$('#authContent').removeClass('d-none');
					$('#formErrors').addClass('d-none');
				})
				.fail(function(xhr) {
					const data = JSON.parse(xhr.responseText);
					$('#errorsList').empty();
					for (const field in data.errors) {
						data.errors[field].forEach(function(error) {
							$('#errorsList').append('<li>' + error + '</li>');
						});
					}
					$('#formErrors').removeClass('d-none');
				});
			});
			
			$('#logoutBtn').on('click', function() {
				$.post('/account/logout/', {
					csrfmiddlewaretoken: getCsrfToken()
				})
				.done(function() {
					$('#authForm').removeClass('d-none');
					$('#authContent').addClass('d-none');
					$('#formErrors').addClass('d-none');
					$('#loginForm')[0].reset();
				});
			});
		});
	</script>
</body>
</html>
