<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Chat - {{ room_name }}</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
	<style>
		.chat-height {
			height: 400px;
		}
		#chat-messages {
			overflow-y: auto;
		}
	</style>
</head>
<body class="p-3">
	<div class="container-fluid">
		<div class="row">
			<div class="col-12">
				<h3>Chat Room: {{ room_name }}</h3>
				<p class="text-muted">Logged in as: <strong>{{ username }}</strong> | <a href="/chat/">Back to rooms</a></p>
			</div>
		</div>

		<div class="row mt-3">
			<div class="col-md-9">
				<div id="chat-messages" class="border p-3 bg-light chat-height">
				</div>
			</div>
			<div class="col-md-3">
				<div class="border p-3 bg-white chat-height">
					<h5 class="mb-3">Connected Users</h5>
					<ul id="user-list" class="list-unstyled">
					</ul>
				</div>
			</div>
		</div>

		<div class="row mt-3">
			<div class="col-12">
				<form id="chat-form">
					<div class="input-group">
						<input 
							type="text" 
							id="chat-message-input" 
							class="form-control" 
							placeholder="Type your message..."
							autocomplete="off"
							required
						>
						<button type="submit" class="btn btn-primary">Send</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	
	<script>
		const roomName = "{{ room_name }}";
		const username = "{{ username }}";
		
		const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
		const wsUrl = protocol + '//' + window.location.host + '/ws/chat/' + roomName + '/';
		const chatSocket = new WebSocket(wsUrl);

		chatSocket.onopen = function(e) {
			console.log('WebSocket connection established');
		};

		function scrollToBottom() {
			const chatMessages = $('#chat-messages');
			chatMessages.scrollTop(chatMessages[0].scrollHeight);
		}

		function updateUserList(users) {
			$('#user-list').empty();
			users.sort();
			users.forEach(function(user) {
				const userItem = $('<li class="mb-2"></li>');
				const userIcon = $('<i class="bi bi-person-fill me-2"></i>');
				const userName = $('<span></span>').text(user);
				
				if (user === username) {
					userName.addClass('fw-bold text-primary');
				}
				
				userItem.append(userIcon).append(userName);
				$('#user-list').append(userItem);
			});
		}

		chatSocket.onmessage = function(e) {
			const data = JSON.parse(e.data);
			
			if (data.type === 'history') {
				// Display message history
				$('#chat-messages').append('<div class="mb-2 text-muted fst-italic small">--- Message History ---</div>');
				data.messages.forEach(function(msg) {
					const messageDiv = $('<div class="mb-2 text-secondary"></div>');
					const usernameSpan = $('<strong></strong>').text(msg.username + ': ');
					const messageText = $('<span></span>').text(msg.message);
					messageDiv.append(usernameSpan).append(messageText);
					$('#chat-messages').append(messageDiv);
				});
				if (data.messages.length > 0) {
					$('#chat-messages').append('<div class="mb-2 text-muted fst-italic small">--- End History ---</div>');
				}
				// scrollToBottom();
			} else if (data.type === 'user_list') {
				// Initial user list when connecting
				updateUserList(data.users);
			} else if (data.type === 'user_join') {
				const joinMessage = $('<div class="mb-2 text-muted fst-italic"></div>')
					.text(data.username + ' has joined the chat');
				$('#chat-messages').append(joinMessage);
				updateUserList(data.users);
				// scrollToBottom();
			} else if (data.type === 'user_leave') {
				const leaveMessage = $('<div class="mb-2 text-muted fst-italic"></div>')
					.text(data.username + ' has left the chat');
				$('#chat-messages').append(leaveMessage);
				updateUserList(data.users);
				// scrollToBottom();
			} else if (data.type === 'message') {
				const messageDiv = $('<div class="mb-2"></div>');
				const usernameSpan = $('<strong></strong>').text(data.username + ': ');
				const messageText = $('<span></span>').text(data.message);
				messageDiv.append(usernameSpan).append(messageText);
				$('#chat-messages').append(messageDiv);
				// scrollToBottom();
			}
			scrollToBottom();
		};

		chatSocket.onclose = function(e) {
			console.log('WebSocket connection closed');
		};

		chatSocket.onerror = function(e) {
			console.error('WebSocket error:', e);
		};

		$('#chat-form').on('submit', function(e) {
			e.preventDefault();
			
			const messageInput = $('#chat-message-input');
			const message = messageInput.val().trim();
			
			if (message) {
				chatSocket.send(JSON.stringify({
					'message': message
				}));
				messageInput.val('');
			}
		});
	</script>
</body>
</html>
